---
title: "Factors associated with seroprevelance of SARS-CoV2 in Orange County"
output: 
  pdf_document:
    extra_dependencies:
      amsmath 
params:
  reclean_data: FALSE
  refit_model0: FALSE
  refit_model1: FALSE
  refit_model2: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE, 
                      error = FALSE,
                      fig.pos = "H")
```


```{r loading-libraries}
# data-wrangling-function chunk
library(tidyverse)
library(here)
library(lubridate)
library(data.table)
# missing-data-table chunk
library(knitr)
library(kableExtra)
usepackage_latex("threeparttable")
# fit-model1 chunk
library(sandwich)
library(tictoc)
library(lme4)
#(BRRR)
library(car) # I don't think I need this anymore
library(mgcv)
```


```{r data-wrangling-function}
read_sero <- function(file_path){
  # Read in and select data of interest-----------------------------------------

  sero_results_original <- read_csv(
    file_path,
    col_types = cols(
      .default = col_skip(),
      E4 = col_integer(),
      DV_PANEL = col_character(),
      DV_IMPORT_TEST_RESULTresult = col_character(),
      Q1 = col_integer(),
      Q2 = col_integer(),
      Q3 = col_character(),
      Q6r1 = col_integer(),
      Q6r2 = col_integer(),
      Q6r3 = col_integer(),
      Q6r4 = col_integer(),
      Q6r5 = col_integer(),
      Q6r6 = col_integer(),
      Q6r7 = col_integer(),
      Q6r8 = col_integer(),
      Q7 = col_integer()
    ) 
  )
  
  
  sero_results_filtered <- sero_results_original %>% 
    filter(E4 == 1) %>% # Only individuals who had a blood test completed
    filter(DV_PANEL != 7) # Only individuals who are not home recruits

  
  # tidy seroprevelance data----------------------------------------------------
  
  sero_results_adjusted <- sero_results_filtered %>% 
    filter(
      DV_IMPORT_TEST_RESULTresult == "Reactive" |
      DV_IMPORT_TEST_RESULTresult == "Non-Reactive"
    ) %>% 
    mutate(covid_pos = factor(
      DV_IMPORT_TEST_RESULTresult,
      levels = c("Non-Reactive", "Reactive"),
      labels = c("no", "yes")
    )) %>% 
    mutate(age_grp = factor(
      case_when(
        Q2 == 2 ~ "18-24",
        Q2 == 3 ~ "25-29",
        Q2 == 4 ~ "30-34",
        Q2 == 5 ~ "35-39",
        Q2 == 6 | Q2 == 7 ~ "40-49",
        Q2 == 8 | Q2 == 9 ~ "50-59",
        Q2 == 10 | Q2 == 11 ~ "60-69",
        Q2 == 12 | Q2 == 13 ~ "70-79",
        Q2 == 14 | Q2 == 15 ~ "80+"
      ),
      levels = c(
        "18-24", "25-29", "30-34", "35-39", "40-49", "50-59", "60-69", "70-79", "80+"
      )
    )) %>% 
    filter(Q1 == 1 | Q1 == 2) %>% 
    mutate(sex = factor(
      Q1,
      levels = c(2, 1),
      labels = c("female", "male")
    )) %>% 
    mutate(race = factor(
      case_when(
        ((Q6r1 == 1) & (Q6r2 + Q6r3 + Q6r4 + Q6r5 + Q6r6 == 0)) ~ "white",
        ((Q6r2 == 2) & (Q6r1 + Q6r3 + Q6r4 + Q6r5 + Q6r6 == 0)) ~ "black",
        ((Q6r3 == 3) & (Q6r1 + Q6r2 + Q6r4 + Q6r5 + Q6r6 == 0)) ~ "hispanic",
        ((Q6r4 == 4) & (Q6r1 + Q6r2 + Q6r3 + Q6r5 + Q6r6 == 0)) ~ "native",
        ((Q6r5 == 5) & (Q6r1 + Q6r2 + Q6r3 + Q6r4 + Q6r6 == 0)) ~ "asian",
        ((Q6r6 == 6) & (Q6r1 + Q6r2 + Q6r3 + Q6r4 + Q6r5 == 0)) ~ "islander",
        TRUE ~ "unknown"
      ),
      levels = c("white", "asian", "black", "hispanic", "native", "islander", "unknown")
    )) %>% 
    select(
      zip = Q3,
      covid_pos,
      age_grp,
      sex,
      race
    ) %>% 
    filter(race != "native")
  
  sero_results_adjusted$race <- droplevels(sero_results_adjusted$race, exclude = "native")

  
  # Add zip code level data and merge with pcr results--------------------------
  zip_area_oc <- read_csv(
    here("data/zip-code-data", "zip-area2.csv"),
    col_types = cols(
      .default = col_skip(),
      NAME = col_character(),
      Zip = col_character(),
      AreaKm = col_double()
      )
    ) %>%
    select(name = NAME, zip = Zip, area_km = AreaKm)
  
  zip_pop_oc <- read_csv(
    here("data/zip-code-data", "zip-pop.csv"),
    col_types = cols(
      .default = col_skip(),
      Zip = col_character(),
      Population = col_integer()
      )
    ) %>%
    drop_na() %>%
    mutate(population = Population / 1000) %>%
    select(zip = Zip, population)
  
  zip_data_merged <- merge(x = zip_area_oc, y = zip_pop_oc, by = "zip")
  zip_data_merged$pop_density <- zip_data_merged$population / zip_data_merged$area_km
  
  zip_income_oc <- read_csv(
    here("data/zip-code-data", "income-by-zip2.csv"),
    col_types = cols(
      .default = col_skip(),
      Zip = col_character(),
      IncomeMed = col_integer(),
      IncPeriodofMeas = col_character()
      )
    ) %>%
    mutate(med_income = IncomeMed / 10000) %>%
    filter(IncPeriodofMeas == "2014-2018") %>%
    select(zip = Zip, med_income)
  
  zip_data_merged <- merge(x = zip_data_merged, y = zip_income_oc, by = "zip")

  zip_education_oc <- read_csv(
    here("data/zip-code-data", "education-by-zip.csv"),
    col_types = cols(
      .default = col_skip(),
      Zip = col_character(),
      PercentBach = col_double()
      )
    ) %>%
    select(zip = Zip, percent_bachelors = PercentBach)
  
  zip_data_merged <- merge(x = zip_data_merged, y = zip_education_oc, by = "zip")

  zip_insurance_oc <- read_csv(
    here("data/zip-code-data", "insurance-by-zip.csv"),
    col_types = cols(
      .default = col_skip(),
      Zip = col_character(),
      PercentInsured = col_double()
      )
    ) %>%                           
    select(zip = Zip, percent_insured = PercentInsured)
  
  zip_data_merged <- merge(x = zip_data_merged, y = zip_insurance_oc, by = "zip")
  
  
  # Scale zip code level variables
  zip_data_merged$adj_pop_density <- scale(
    zip_data_merged$pop_density , 
    center = TRUE, 
    scale = TRUE
    )
  
  zip_data_merged$adj_med_income <- scale(
    zip_data_merged$med_income, 
    center = TRUE, 
    scale = TRUE
    )
  
  zip_data_merged$adj_perc_bach <- scale(
    zip_data_merged$percent_bachelors,
    center = TRUE,
    scale = TRUE
    )
  
  zip_data_merged$adj_perc_bach_quar <- with(
    zip_data_merged,
    cut(adj_perc_bach,
        breaks = quantile(adj_perc_bach, 
        probs = seq(0, 1, by = 0.25)),
        include.lowest = TRUE,
        labels = c("Q1", "Q2", "Q3", "Q4"))
    )
  
  zip_data_merged$adj_perc_insured <- scale(
    zip_data_merged$percent_insured,
    center = TRUE,
    scale = TRUE
    )
  
  zip_data_merged$adj_perc_insured_quar <- with(
    zip_data_merged,
    cut(
      adj_perc_insured,
      breaks = quantile(adj_perc_insured, probs = seq(0, 1, by = 0.25)),
      include.lowest = TRUE,
      labels = c("Q1", "Q2", "Q3", "Q4")
      )
    )
  
  # We don't have an area estimate for 92678 so we replace with 92679
  sero_results_adjusted$old_zip <- sero_results_adjusted$zip
  sero_results_adjusted$zip[sero_results_adjusted$old_zip == "92678"] <- "92679"
  sero_results_merged <- merge(x = sero_results_adjusted, y = zip_data_merged, by = "zip")
  sero_results_merged$old_zip <- factor(sero_results_merged$old_zip)
  sero_results_merged$zip <- factor(sero_results_merged$zip)
  
  
  # Count missing values--------------------------------------------------------
  missing_vec <- c(
    nrow(sero_results_filtered) , # number of observations with test date between start date and end date
    nrow(sero_results_filtered) - nrow(sero_results_adjusted),  # number of NA for age, sex and zip
    nrow(sero_results_adjusted) - nrow(sero_results_merged) # number of invalid or non Orange County zip codes
  )
  names(missing_vec) <- c(
    "full_num_data_cases", 
    "num_na_cases_removed", 
    "num_bad_zip_cases_removed"
  )
  
  
  list(
    "sero_results_merged" = sero_results_merged, 
    "zip_data_merged" = zip_data_merged, 
    "missing" = missing_vec
  )
}
```


```{r load-clean-data}
if (params$reclean_data) {
  all_sero_and_zip <- read_sero(
    file_path = here("data/seroprevelance-data", "oc-seroprevelance-data-2020-08-01.csv")
  )
  
  save(all_sero_and_zip, file = here("data/seroprevelance-data", "cleaned_process_sero_data.Rdata"))
} else {
  load(file = here("data/seroprevelance-data", "cleaned_process_sero_data.Rdata"))
}

all_sero <- data.frame(all_sero_and_zip[["sero_results_merged"]])
all_zip <- data.frame(all_sero_and_zip[["zip_data_merged"]])
sero_missing <- all_sero_and_zip[["missing"]]
```


```{r missing-data-table}
usable_counts <- c(
  sero_missing[1],
  sero_missing[1] - sero_missing[2],
  sero_missing[1] - sum(sero_missing[2:3])
)

tab_obs <- data.frame(
  c(NA, sero_missing[2:3]), 
  usable_counts
)
rownames(tab_obs) <- c(
  "Unmodified",
  "Missing or Inconclusive[note]",
  "Invalid Zip Code"
)

kable(
  tab_obs,
  col.names = c(
    "With Issue", 
    "After Removal"
  ),
  format = "latex",
  caption = paste(
    "Number of sero-positive COVID-19 tests in Orange County from ",
      params$first_test_date, " to ", params$last_test_date,
      ". Includes number removed from data by type of issue for this analysis.",
    sep = "")
  ) %>%
  kable_styling(latex_options = c("HOLD_position")) %>% 
  add_header_above(c(" " = 1, "Number of Tests" = 2), line = TRUE) %>% 
  column_spec(column = 2:3, width = "5.5cm") %>% 
  add_footnote(
    c(
      "Number without conclusive test result or complete demographic information"
      ),
    notation = "symbol",
    threeparttable = TRUE
    )
```


```{r results-functions} 
compute_ci_logistic_glm <- function(model, alpha = 0.05, param_names, include_pvalues = FALSE) {
  #does not include intercept or median income
  model_summary <- summary(model)
  coeffs <- model_summary$coefficients[-1, 1]
  se_robust <- sqrt(diag(sandwich(model)))[-1]
  model_sum <- data.frame("odds" = exp(coeffs),
                          "lower_bound" = exp(coeffs - qnorm(1 - alpha / 2) * se_robust),
                          "upper_bound" = exp(coeffs + qnorm(1 - alpha / 2) * se_robust),
                          "p-value" =  model_summary$coefficients[-1, 4],
                          "param_names" = param_names)
  if(include_pvalues){
    return("model_sum" = model_sum)
  } else {
    return("model_sum" = model_sum[, -4])
  }
}
```


For simplicity let  
$O_i$ be the odds of testing positive for COVID-19 in Orange County.  
$\overrightarrow{\beta}_{\text{Age Group}} = (\beta_{\text{Age[18-24]}}, \beta_{\text{Age[25-29]}}, \beta_{\text{Age[30-34]}}, \beta_{\text{Age[35-39]}}, \beta_{\text{Age[40-44]}}, \beta_{\text{Age[45-49]}}, \beta_{\text{Age[50-54]}}, \\ \beta_{\text{Age[55-59]}}, \beta_{\text{Age[60-64]}}, \beta_{\text{Age[65-69]}}, \beta_{\text{Age[70-74]}}, \beta_{\text{Age[75-79]}}, \beta_{\text{Age[80-84]}}, \beta_{\text{Age[85+]}})$  
$\overrightarrow{\beta}_{\text{Race}} = (\beta_{\text{Asian}}, \beta_{\text{Black}}, \beta_{\text{Hispanic}}, \beta_{\text{PacificIslander}}, \beta_{\text{Unknown}})$  
$\overrightarrow{\beta}_{\text{College}} = (\beta_{\text{\% with College Degree Quartile 2}}, \beta_{\text{\% with College Degree Quartile 3}}, \beta_{\text{\% with College Degree Quartile 4}})$  
$\overrightarrow{\beta}_{\text{Insurance}} = (\beta_{\text{\% with Insurance Quartile 2}}, \beta_{\text{\% with Insurance Quartile 3}}, \beta_{\text{\% with Insurance Quartile 4}})$


Model 0:
\begin{equation}
\label{eq:Model0}
	\begin{split}
		\log(O_i) &= \beta_0 + \overrightarrow{\beta}_{\text{Age Group}}\overrightarrow{\text{Age Group}}_i + \beta_{\text{Sex}}\text{Sex}_i + \overrightarrow{\beta}_{\text{Race}}\overrightarrow{\text{Race}}_i\\
		&+ \overrightarrow{\beta}_{\text{College}}\overrightarrow{\text{\% with College Degree Quartile}}_i\\
		&+ \overrightarrow{\beta}_{\text{Insurance}}\overrightarrow{\text{\% with Medical Insurance Quartile}}_i \\
		&+ \beta_{\text{Population Density}}\text{Population Density}_i + \beta_{\text{Median Income}}\text{Median Income}_i,
	\end{split}
\end{equation}
without a random intercept for zip code.


```{r fit-model0}
if (params$refit_model0) {
  fit0 <- glm(
    formula = covid_pos ~ age_grp + sex + race + 
              adj_perc_bach_quar + adj_perc_insured_quar +
              adj_pop_density + adj_med_income,
    family = binomial, 
    data = all_sero
    )

  save(fit0, file = here("analysis/testing-seropositive-regression-results", "fit0.Rdata"))
} else {
  load(file = here("analysis/testing-seropositive-regression-results", "fit0.Rdata"))
}
```


Model 1:
\begin{equation}
\label{eq:Model1}
	\begin{split}
		\log(O_i) &= \beta_0 + \overrightarrow{\beta}_{\text{Age Group}}\overrightarrow{\text{Age Group}}_i + \beta_{\text{Sex}}\text{Sex}_i + \overrightarrow{\beta}_{\text{Race}}\overrightarrow{\text{Race}}_i\\
		&+ \overrightarrow{\beta}_{\text{College}}\overrightarrow{\text{\% with College Degree Quartile}}_i\\
		&+ \overrightarrow{\beta}_{\text{Insurance}}\overrightarrow{\text{\% with Medical Insurance Quartile}}_i \\
		&+ \beta_{\text{Population Density}}\text{Population Density}_i + \beta_{\text{Median Income}}\text{Median Income}_i,
	\end{split}
\end{equation}
with a random intercept for zip code.


```{r fit-model1}
if (params$refit_model1) {
  tic()
  fit1a <- glmer(
    formula = covid_pos ~ age_grp + sex + race + 
              adj_perc_bach_quar + adj_perc_insured_quar +
              adj_pop_density + adj_med_income +
              (1 | zip),              
    family = binomial, 
    data = all_sero,
    control = glmerControl(optimizer ="bobyqa", optCtrl = list(maxfun = 2e6))
    )
  toc()

  tic()
  ss <- getME(fit1a, c("theta","fixef"))
  fit1b <- update(
    fit1a,
    start = ss,
    control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e6))
  )
  toc()
  fit1 <- fit1b
  # Message:
  # variance-covariance matrix computed from finite-difference Hessian is 
  # not positive definite or contains NA values: 
  # falling back to var-cov estimated from RXvariance-covariance
  
  save(fit1, file = here("analysis/testing-seropositive-regression-results", "fit1.Rdata"))
} else {
  load(file = here("analysis/testing-seropositive-regression-results", "fit1.Rdata"))
}
```


```{r prep-seropos-modeled-by-num-cases-data}
# load in cleaned positivity data
load(file = here("data/positivity-data", "cleaned_process_pcr_data.Rdata"))
  
all_pcr <- data.frame(all_pcr_and_zip[["pcr_results_merged"]])
all_zip <- data.frame(all_pcr_and_zip[["zip_data_merged"]]) %>% 
  mutate(zip = factor(zip))
all_missing <- all_pcr_and_zip[["missing"]]
all_inconsist_ids <- all_pcr_and_zip[["inconsistencies"]]

# Tabulate cumulative number of cases in each zip code
cases_in_zip <- all_pcr %>% 
  filter(covid_positive == 1) %>% 
  group_by(zip) %>% 
  summarise(num_cases_in_zip = n())

# Make df of zip code, population, num_cases_in_zip, perc_zip_covid_pos 
case_by_zip_pop <- merge(all_zip, cases_in_zip, by = "zip") %>% 
  select(zip, num_cases_in_zip, population) %>% 
  mutate(perc_zip_covid_pos = num_cases_in_zip/population)

all_sero <- merge(all_sero, case_by_zip_pop, by = "zip")
``` 


Model 2:
\begin{equation}
\label{eq:Model2}
	\begin{split}
		\log(O_i) &= \beta_0 + \overrightarrow{\beta}_{\text{Age Group}}\overrightarrow{\text{Age Group}}_i + \beta_{\text{Sex}}\text{Sex}_i + \overrightarrow{\beta}_{\text{Race}}\overrightarrow{\text{Race}}_i\\
		&+ \overrightarrow{\beta}_{\text{College}}\overrightarrow{\text{\% with College Degree Quartile}}_i\\
		&+ \overrightarrow{\beta}_{\text{Insurance}}\overrightarrow{\text{\% with Medical Insurance Quartile}}_i \\
		&+ \beta_{\text{Population Density}}\text{Population Density}_i + \beta_{\text{Median Income}}\text{Median Income}_i\\
		&+ \beta_{\text{\% of Zip Code SARS-CoV2+}}\text{\% of Zip Code SARS-CoV2+}_i,
	\end{split}
\end{equation}
without a random intercept for zip code.


```{r fit-seropos-modeled-by-num-cases}
if (params$refit_model2) {
  fit2 <- glm(
    formula = covid_pos ~ age_grp + sex + race + 
              adj_perc_bach_quar + adj_perc_insured_quar +
              adj_pop_density + adj_med_income +
              perc_zip_covid_pos,
    family = binomial, 
    data = all_sero
    )

  save(fit2, file = here("analysis/testing-seropositive-regression-results", "fit2.Rdata"))
} else {
  load(file = here("analysis/testing-seropositive-regression-results", "fit2.Rdata"))
}
```


```{r compute-model-odds-cis}
parameter_names <- c(
  "25-29", "30-34", "35-39", "40-49", "50-59", "60-69", "70-79", "80+", 
  "Male",
  "Asian", "Black", "Hispanic", "Pacific Islander", "Unknown",
  "2nd Quartile", "3rd Quartile", "4th Quartile",
  " 2nd Quartile", " 3rd Quartile", " 4th Quartile",
  "Population Density (1000ppl/km^2)", 
  "Median Income (std. dev.)"
)

summary_fit0 <- compute_ci_logistic_glm(fit0, param_names = parameter_names)
summary_fit2 <- compute_ci_logistic_glm(fit2, param_names = c(parameter_names, "% of Zip SARS-CoV2+"))
```


```{r bic-table}
compare_bic <- BIC(fit0, fit1, fit2) 
row.names(compare_bic) <- c("Model 0", "Model 1", "Model 2")

kable(compare_bic,
      col.names = c("Degrees of Freedom", "BIC"),
      format = "latex",
      caption = "Model comparison using BIC shows negligible difference in modeling odds of testing sero-positive for COVID-19 in Orange County. Therefore the simpler model, Model 0, was chosen.") %>%
  kable_styling(latex_options = "HOLD_position")
```


```{r fit0-model-results-table}
fm_sum <- summary(fit0)

intercept <- paste0(
  round(exp(fm_sum$coefficients[1, 1]), 3),
  " (",
  round(exp(fm_sum$coefficients[1, 1] - qnorm(0.975) * sqrt(diag(sandwich(fit0)))[1]), 3),
  ",",
  round(exp(fm_sum$coefficients[1, 1] + qnorm(0.975) * sqrt(diag(sandwich(fit0)))[1]), 3),
  ")"
)


fit_final_model <- summary_fit0

rr_fm <- round(fit_final_model[, "odds"], 3)
ci_lb_fm <- round(fit_final_model[, "lower_bound"], 2)
ci_ub_fm <- round(fit_final_model[, "upper_bound"], 2)
#p_values_fm <- fit_final_model$p.value
#p_values_fm <- ifelse(p_values_fm <= 0.001, "0.000", paste(round(p_values_fm, 3)))

reference_group <- c(
  TRUE, rep(FALSE, 8),
  TRUE, FALSE,
  TRUE, rep(FALSE, 5),
  TRUE, rep(FALSE, 3),
  TRUE, rep(FALSE, 3),
  FALSE,
  FALSE
)

table_fm <- data.frame(matrix(NA, nrow = nrow(fit_final_model) + sum(reference_group), ncol = 3))
colnames(table_fm) <- c("SARS-CoV2+", "Total", "with (95% CI[note])")
rownames(table_fm) <- c(
  "18-24", "25-29", "30-34", "35-39", "40-49", "50-59", "60-69", "70-79", "80+",
  "Female", "Male",
  "White", "Asian", "Black", "Hispanic", "Pacific Islander", "Unknown",
  "1st Quartile", "2nd Quartile", "3rd Quartile", "4th Quartile",
  "1st Quartile ", "2nd Quartile ", "3rd Quartile ", "4th Quartile ",
  "Population Density (1000ppl/km^2)",
  "Median Income (std. dev.)"
)

          
non_ref_counter <- 1
for(i in 1:nrow(table_fm)) {
  if (reference_group[i]) {
    #table_fm[i, 1] <- "Reference"
    table_fm[i, 3] <- "Reference"
  } else {
    table_fm[i, 3] <- paste(rr_fm[non_ref_counter], " (", 
                          ci_lb_fm[non_ref_counter], ", ", 
                          ci_ub_fm[non_ref_counter], ")", 
                          sep = "")
    #table_fm[i, 2] <- p_values_fm[non_ref_counter]
    non_ref_counter <- non_ref_counter + 1
  }
}      

variable_counts <- data.frame(matrix(NA,  nrow = nrow(fit_final_model) + sum(reference_group), ncol = 2))
sero_pos <- all_sero[all_sero$covid_pos == "yes", ]
quant_vars <- c("adj_pop_density", "adj_med_income")
order_quant_vars <- c(nrow(table_fm) - 1, nrow(table_fm))
variable_counts[order_quant_vars, c(1, 2)] <- c("", "")

qual_vars <- c("age_grp", "sex", "race", "adj_perc_bach_quar", "adj_perc_insured_quar")
order_qual_vars <- (1:nrow(table_fm))[-order_quant_vars]

qual_vars_ordered <- c(
  "age_grp.18-24", "age_grp.25-29", "age_grp.30-34", "age_grp.35-39", 
  "age_grp.40-49", "age_grp.50-59","age_grp.60-69", "age_grp.70-79", "age_grp.80+",
  "sex.female", "sex.male", 
  "race.white", "race.asian", "race.black", "race.hispanic", 
  "race.islander", "race.unknown",
  "adj_perc_bach_quar.Q1", "adj_perc_bach_quar.Q2",
  "adj_perc_bach_quar.Q3", "adj_perc_bach_quar.Q4",
  "adj_perc_insured_quar.Q1", "adj_perc_insured_quar.Q2",
  "adj_perc_insured_quar.Q3", "adj_perc_insured_quar.Q4"
)
 
calc_freq <- function(df, order_vars) {
  qual_count <- unlist(apply(df, MARGIN = 2, FUN = table))

  qual_count <- qual_count[order_vars]
  qual_freq <- round(100 * qual_count / nrow(df), 2)
  paste(qual_count, " (", qual_freq, "%)", sep = "")
}

variable_counts[order_qual_vars, 2] <- calc_freq(all_sero[, qual_vars], qual_vars_ordered)
variable_counts[order_qual_vars, 1] <- calc_freq(sero_pos[, qual_vars], qual_vars_ordered)

table_fm[, 2] <- variable_counts[, 2]
table_fm[, 1] <- variable_counts[, 1]

kable(
  table_fm, 
  format = "latex", 
  caption = paste(
    "Model 0 regression estimation of adjusted odds ratio of testing sero-positive for SARS-CoV2 in Orange County.", 
    sep = ""
    )
  ) %>%
  kable_styling(latex_options = c("HOLD_position"), font_size = 11) %>%
  pack_rows("Age", 1, 9, bold = FALSE) %>% 
  pack_rows("Sex", 10, 11, bold = FALSE) %>%
  pack_rows("Race[note]", 12, 17, bold = FALSE) %>%
  pack_rows("% with College Degree[note]", 18, 21, bold = FALSE) %>%
  pack_rows("% with Insurance", 22, 24, bold = FALSE) %>% 
  add_header_above(c(" " = 1, "Counts" = 2, "Adjusted Odds Ratio[note]" = 1), line = FALSE) %>% 
  add_footnote(
    c(
      paste0(
        "Model intercept represents odds of testing sero-positive for SARS-CoV2 for a white female diagnosed with SARS-CoV-2 in the 18-24 age group in a zip code in the first quartile of college degree and insured with the average population density in Orange County. The odds of this individual testing sero-positive is estimated to be ",
        intercept,
        collapse = ""
      ), 
      "95% confidence interval computed with robust standard errors",
      "Native American/Native Alaskan race group not included in analysis due to lack of data, no individual of this race group tested seropositive.",
      "The esimated percent of people with a bachelor's degree, and similarly the estimated percent of people with medical insurance, in an individual's zip code"
    ),
    notation = "symbol"
  )  
```


```{r fit0-model-results-plot, fig.align="center", fig.cap="Logistic model 0 results for odds of testing sero-positive for SARS-CoV2 in Orange County. Pasific Islander adjusted odds ratio omitted due to width of confidence interval (1.05, 15.14)."}

fm_results_with_ref <- rbind(
  c(1, 0.99, 1.01, paste0(c("Age", rep(" ", 39), "[ref: 18-24]"), collapse = "")),
  summary_fit0[1:8, ],
  c(1, 0.99, 1.01, paste0(c("Sex", rep(" ", 38), "[ref: Female]"), collapse = "")),
  summary_fit0[9, ],
  c(1, 0.99, 1.01, paste0(c("Race", rep(" ", 38), "[ref: White]"), collapse = "")),
  summary_fit0[10:14, ],
  c(1, 0.99, 1.01, "% with College Degree [ref: 1st Quartile]"),
  summary_fit0[15:17, ],
  c(1, 0.99, 1.01, paste0(c("% with Insurance", rep(" ", 10), "[ref: 1st Quartile]"), collapse = "")),
  summary_fit0[18:nrow(summary_fit0), ]
)

fm_results_with_ref$odds <- as.double(fm_results_with_ref$odds)
fm_results_with_ref$lower_bound <- as.double(fm_results_with_ref$lower_bound)
fm_results_with_ref$upper_bound <- as.double(fm_results_with_ref$upper_bound)

variable_colors <- c(
  "white",
  rep("black", 8),
  "white",
  rep("black", 1),
  "white",
  rep("black", 4),
  "white",
  rep("black", 3),
  "white",
  rep("black", 3),
  rep("black", 2)
)

fm_results_with_ref <- fm_results_with_ref %>% 
  filter(param_names != "Pacific Islander")

ggplot(fm_results_with_ref, aes(x = param_names, y = odds), size = 5, color = variable_colors) +
  ylim(min(fm_results_with_ref$lower_bound), max(fm_results_with_ref$upper_bound)) +
  geom_point(color = variable_colors) +
  geom_linerange(aes(ymin = lower_bound, ymax = upper_bound), color = variable_colors) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "black") +
  ylab("Adjusted Odds Ratio") +
  coord_flip() +
  theme(
    axis.title.y = element_blank(),
    axis.text.x=element_text(size = 12, colour="black"),
    axis.text.y=element_text(colour="black", hjust = 1),
    axis.ticks.y = element_blank(),
    axis.line.x = element_line(color = "black"),
    panel.grid.major = element_line(colour = "gray"),
    panel.background = element_blank(),
    plot.title = element_text(hjust=0)
  ) +
  scale_x_discrete(limits = rev(fm_results_with_ref$param_names)) +
  scale_y_continuous(breaks = seq(0, max(fm_results_with_ref$upper_bound), by = 0.5)) +
  ggtitle("Results of SARS-CoV2 seropositivity logisitic regression")
```


```{r fita-model-results-table}
fm_sum <- summary(fit2)

intercept <- paste0(
  round(exp(fm_sum$coefficients[1, 1]), 3),
  " (",
  round(exp(fm_sum$coefficients[1, 1] - qnorm(0.975) * sqrt(diag(sandwich(fit2)))[1]), 3),
  ",",
  round(exp(fm_sum$coefficients[1, 1] + qnorm(0.975) * sqrt(diag(sandwich(fit2)))[1]), 3),
  ")"
)


fit_final_model <- summary_fit2

rr_fm <- round(fit_final_model[, "odds"], 3)
ci_lb_fm <- round(fit_final_model[, "lower_bound"], 2)
ci_ub_fm <- round(fit_final_model[, "upper_bound"], 2)
#p_values_fm <- fit_final_model$p.value
#p_values_fm <- ifelse(p_values_fm <= 0.001, "0.000", paste(round(p_values_fm, 3)))

reference_group <- c(
  TRUE, rep(FALSE, 8),
  TRUE, FALSE,
  TRUE, rep(FALSE, 5),
  TRUE, rep(FALSE, 3),
  TRUE, rep(FALSE, 3),
  FALSE,
  FALSE,
  FALSE
)

table_fm <- data.frame(matrix(NA, nrow = nrow(fit_final_model) + sum(reference_group), ncol = 3))
colnames(table_fm) <- c("SARS-CoV2+", "Total", "with (95% CI[note])")
rownames(table_fm) <- c(
  "18-24", "25-29", "30-34", "35-39", "40-49", "50-59", "60-69", "70-79", "80+",
  "Female", "Male",
  "White", "Asian", "Black", "Hispanic", "Pacific Islander", "Unknown",
  "1st Quartile", "2nd Quartile", "3rd Quartile", "4th Quartile",
  "1st Quartile ", "2nd Quartile ", "3rd Quartile ", "4th Quartile ",
  "Population Density (1000ppl/km^2)",
  "Median Income (std. dev.)",
  "% of Zip Code SARS-CoV2+[note]"
)

          
non_ref_counter <- 1
for(i in 1:nrow(table_fm)) {
  if (reference_group[i]) {
    #table_fm[i, 1] <- "Reference"
    table_fm[i, 3] <- "Reference"
  } else {
    table_fm[i, 3] <- paste(rr_fm[non_ref_counter], " (", 
                          ci_lb_fm[non_ref_counter], ", ", 
                          ci_ub_fm[non_ref_counter], ")", 
                          sep = "")
    #table_fm[i, 2] <- p_values_fm[non_ref_counter]
    non_ref_counter <- non_ref_counter + 1
  }
}      

variable_counts <- data.frame(matrix(NA,  nrow = nrow(fit_final_model) + sum(reference_group), ncol = 2))
sero_pos <- all_sero[all_sero$covid_pos == "yes", ]
quant_vars <- c("adj_pop_density", "adj_med_income", "perc_zip_covid_pos")
order_quant_vars <- (nrow(table_fm) - 2):nrow(table_fm)
variable_counts[order_quant_vars, c(1, 2)] <- c("", "")

qual_vars <- c("age_grp", "sex", "race", "adj_perc_bach_quar", "adj_perc_insured_quar")
order_qual_vars <- (1:nrow(table_fm))[-order_quant_vars]

qual_vars_ordered <- c(
  "age_grp.18-24", "age_grp.25-29", "age_grp.30-34", "age_grp.35-39", 
  "age_grp.40-49", "age_grp.50-59","age_grp.60-69", "age_grp.70-79", "age_grp.80+",
  "sex.female", "sex.male", 
  "race.white", "race.asian", "race.black", "race.hispanic", 
  "race.islander", "race.unknown",
  "adj_perc_bach_quar.Q1", "adj_perc_bach_quar.Q2",
  "adj_perc_bach_quar.Q3", "adj_perc_bach_quar.Q4",
  "adj_perc_insured_quar.Q1", "adj_perc_insured_quar.Q2",
  "adj_perc_insured_quar.Q3", "adj_perc_insured_quar.Q4"
)
 
calc_freq <- function(df, order_vars) {
  qual_count <- unlist(apply(df, MARGIN = 2, FUN = table))

  qual_count <- qual_count[order_vars]
  qual_freq <- round(100 * qual_count / nrow(df), 2)
  paste(qual_count, " (", qual_freq, "%)", sep = "")
}

variable_counts[order_qual_vars, 2] <- calc_freq(all_sero[, qual_vars], qual_vars_ordered)
variable_counts[order_qual_vars, 1] <- calc_freq(sero_pos[, qual_vars], qual_vars_ordered)

table_fm[, 2] <- variable_counts[, 2]
table_fm[, 1] <- variable_counts[, 1]

kable(
  table_fm, 
  format = "latex", 
  caption = paste(
    "Model 0 regression estimation of adjusted odds ratio of testing sero-positive for SARS-CoV2 in Orange County.", 
    sep = ""
    )
  ) %>%
  kable_styling(latex_options = c("HOLD_position"), font_size = 11) %>%
  pack_rows("Age", 1, 9, bold = FALSE) %>% 
  pack_rows("Sex", 10, 11, bold = FALSE) %>%
  pack_rows("Race[note]", 12, 17, bold = FALSE) %>%
  pack_rows("% with College Degree[note]", 18, 21, bold = FALSE) %>%
  pack_rows("% with Insurance", 22, 24, bold = FALSE) %>% 
  add_header_above(c(" " = 1, "Counts" = 2, "Adjusted Odds Ratio[note]" = 1), line = FALSE) %>% 
  add_footnote(
    c(
      paste0(
        "Model intercept represents odds of testing sero-positive for SARS-CoV2 for a white female diagnosed with SARS-CoV2 in the 18-24 age group in a zip code in the first quartile of college degree and insured with the average population density, and average percent of SARS-CoV2 positive individuals in Orange County. The odds of this individual testing sero-positive is estimated to be ",
        intercept,
        collapse = ""
      ), 
      "95% confidence interval computed with robust standard errors",
      "Number of individuals who tested positive in individual's zip code reported to OC Public Health Department from March 1st to August 16th, divided by estimated population of zipcode",
      "Native American/Native Alaskan race group not included in analysis due to lack of data, no individual of this race group tested seropositive",
      "The esimated percent of people with a bachelor's degree, and similarly the estimated percent of people with medical insurance, in an individual's zip code"
    ),
    notation = "symbol"
  )  
```















