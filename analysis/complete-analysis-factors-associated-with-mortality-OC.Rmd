---
title: "Complete Analysis: Factors associated with morality among people diagnosed
  with COVID-19"
output: 
  pdf_document:
    extra_dependencies:
      amsmath 
params:
  reclean_data: TRUE
  first_test_date: "2020-03-01"
  last_test_date: "2020-08-16"
  refit_model1: FALSE
  refit_model2: FALSE
  refit_model3: FALSE
  refit_model4: FALSE
  refit_model5: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      error = FALSE,
                      fig.pos = "H")
```


```{r loading-libraries}
# data-wrangling-function chunk
library(tidyverse)
library(here)
library(lubridate)
library(data.table)
# missing-data-table chunk
library(knitr)
library(kableExtra)
# fit-model1 chunk
library(tictoc)
library(lme4)
library(BRRR)
library(car) # I dont think I need this anymore
library(mgcv)

library(ggplot2)
```


```{r data-wrangling-function}
read_pos_pcr <- function(file_path, start_date, end_date) {
  pos_results_original <- read_csv(
    file_path,
    col_types = cols(
      .default = col_skip(),
      SpCollDt = col_date("%m/%d/%Y"),
      DtDeath = col_date("%m/%d/%Y"),
      DeathDueCOVID = col_character(),
      Zip = col_character(),
      Age = col_integer(),
      Gender = col_character(),
      Ethnicity = col_character(),
      Race = col_character()
    )
  ) 
  
  full_num_data_cases <- pos_results_original %>% 
    filter(SpCollDt >= ymd(start_date) & SpCollDt <= ymd(end_date)) %>% 
    nrow()
  
  
  pos_results_original$Race[is.na(pos_results_original$Race)] <- "Unknown"
  pos_results_original$Ethnicity[is.na(pos_results_original$Ethnicity)] <- "Unknown"

  hispanic_race_unknown <- (
    (pos_results_original$Race == "Other" & 
     pos_results_original$Ethnicity == "Hispanic or Latino") |
    (pos_results_original$Race == "Unknown" & 
     pos_results_original$Ethnicity == "Hispanic or Latino") |
    (pos_results_original$Race == "Multiple Races" & 
     pos_results_original$Ethnicity == "Hispanic or Latino") 
  )
  
  non_hispanic_unknown <- (
    (pos_results_original$Race == "Unknown" & 
     pos_results_original$Ethnicity != "Hispanic or Latino") |
    (pos_results_original$Race == "Multiple Races" & 
     pos_results_original$Ethnicity != "Hispanic or Latino")
  )
  
  pos_results_original_new_race <- data.frame(
    pos_results_original, 
    "race1" = str_to_lower(pos_results_original$Race)
  )
  
  pos_results_original_new_race$race1[hispanic_race_unknown] <- "hispanic or latino"
  pos_results_original_new_race$race1[non_hispanic_unknown] <- "unknown"
  
  
  pos_results_original_new_race$DeathDueCOVID <- replace_na(
    pos_results_original_new_race$DeathDueCOVID,
    "unknown"
  )
  pos_results_original_new_race$Age <- replace_na(
    pos_results_original_new_race$Age,
    -999
  )
  pos_results_original_new_race$Zip <- replace_na(
    pos_results_original_new_race$Zip,
    "unknown"
  )
  
  
  pos_results_adjusted <- pos_results_original_new_race %>% 
    mutate(death_due_to_covid = str_to_lower(DeathDueCOVID)) %>% 
    mutate(sex = fct_collapse(
      str_to_lower(Gender),
      male = "m",
      female = "f",
      unknown = c("o", "u")
      )) %>%
    mutate(race = factor(
      race1, 
      levels = c(
        "white",
        "asian",
        "black or african american",
        "hispanic or latino",
        "american indian or alaska native",
        "native hawaiian or other pacific islander",
        "other",
        "unknown"
        ),
      )) %>% 
    select(
      test_date = SpCollDt,
      death_date = DtDeath,
      death_due_to_covid,
      zip = Zip,
      age = Age,
      sex,
      race
    ) %>% 
    filter((test_date >= ymd(start_date)) & (test_date <= ymd(end_date))) %>% 
    filter(sex != "unknown") %>% 
    filter(age != -999) %>% 
    filter(zip != "unknown") %>% 
    mutate(zip = str_sub(zip, end = 5)) %>% 
    arrange(test_date) 
  # make time variable for time since start date to ?
}

```


```{r load-clean-data}
if (params$reclean_data) {
  pos_pcr_and_zip <- read_pos_pcr(
    file_path = here("data", "all-positive-tests-update-11-2-20.csv"),
    start_date = params$first_test_date,
    end_date = params$last_test_date
    )
  
  pos_pcr <- data.frame(pos_pcr_and_zip[["pcr_results_merged"]])
  pos_zip <- data.frame(pos_pcr_and_zip[["zip_data_merged"]])
  pos_counts <- pos_pcr_and_zip[["counts"]]
  pos_inconsist_ids <- pos_pcr_and_zip[["inconsistencies"]]
  save(pos_pcr_and_zip, file = here("data", "cleaned_process_pos_pcr_data.Rdata"))
} else {
  load(file = here("data", "cleaned_process_pos_pcr_data.Rdata"))
  
  pos_pcr <- data.frame(pos_pcr_and_zip[["pcr_results_merged"]])
  pos_zip <- data.frame(pos_pcr_and_zip[["zip_data_merged"]])
  pos_counts <- pos_pcr_and_zip[["counts"]]
  pos_inconsist_ids <- pos_pcr_and_zip[["inconsistencies"]]
}
```

