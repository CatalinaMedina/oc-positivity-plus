---
title: "Examine data distributions"
author: "Catalina Medina"
date: "10/15/2020"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fi.pos = "H", warning = FALSE, message = FALSE, fig.align = "center")
```


```{r }
library(ggplot2)
source(here::here("data-wrangling", "read-sanitize-oc-covid-data.R"))

all_pcr_and_zip <- read_all_pcr(file_path = here("data", "all-elr-pcr-tests-updated-2020-10-05.csv"),
                                start_date = "2020-03-01",
                                end_date = "2020-08-16")
all_pcr <- data.frame(all_pcr_and_zip[["pcr_results_merged"]])
all_zip <- data.frame(all_pcr_and_zip[["zip_data_merged"]])
all_counts <- all_pcr_and_zip[["counts"]]
all_inconsist_ids <- all_pcr_and_zip[["inconsistencies"]]

```


```{r}
all_pcr$race_known <- ifelse(all_pcr$race == "unknown", "No", "Yes")

ggplot(all_pcr, aes(x = race_known)) +
  geom_bar(aes(fill = as.factor(covid_positive)))

ggplot(all_pcr, aes(x = as.factor(covid_positive))) +
  geom_bar(aes(fill = race_known))
```

```{r}
all_pcr$race_known <- ifelse(all_pcr$race == "unknown", 0, 1)

ggplot(all_pcr, aes(x = zip, y = race_known))+
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(size = 7, angle = 90))

#Highest two zipcodes
all_zip$name[all_zip$zip == 92703]
all_zip$name[all_zip$zip == 92804]
```

There are two zip codes that have an extremely high number of unknown race observations. The highest is Santa Ana (92703) but this is reasonable since that zip code has the 6th highest population and the 2nd highest population density. The zip code with the second highest number of unknowns is Anaheim (92804) which is also reasonable since they have the 3rd highest population and the 4th highest population density.


```{r eval = FALSE}

unknown_race_by_zip <- all_pcr %>% 
  group_by(zip) %>% 
  summarize(per_race_unknown = sum(race_known == 0)/n())

quantile(unknown_race_by_zip$per_race_unknown)

unknown_race_by_zip_pop <- data.frame(cbind(unknown_race_by_zip[order(unknown_race_by_zip$zip), ], 
                                            "population" = all_zip[order(all_zip$zip), "population"]))

unknown_race_by_zip_pop[order(unknown_race_by_zip_pop$per_race_unknown, decreasing = TRUE), ]

#library(reshape2)
#

# 
# unknown_race_pop_by_zip_melt <- melt(unknown_race_by_zip_pop2, id = "zip")
# 
# ggplot (unknown_race_pop_by_zip_melt, aes(x=zip, y=value, fill=variable)) + 
#   geom_bar (stat="identity", position = "identity", alpha = .3) +
#   theme(axis.text.x = element_text(size = 7, angle = 90))
# 
# 

 unknown_race_by_zip_pop2 <- data.frame(cbind(unknown_race_by_zip[order(unknown_race_by_zip$zip), ], 
                                  "population" = all_zip[order(all_zip$zip), "population"])) %>% 
   mutate("scaled_num_unknowns" = (population * per_race_unknown)) %>% 
   select(zip,
          scaled_num_unknowns,
          population)
 
 ggplot(unknown_race_by_zip_pop2, aes(x = zip)) +
   geom_bar(aes(y=population), stat="identity", position ="identity", alpha=.3, fill='blue', color='lightblue4') +
   geom_bar(aes(y=scaled_num_unknowns), stat="identity", position="identity", alpha=.8, fill='black', color='red')


```









```{r }
#bimodial distrubtion of income across data
hist(all_zip$med_income, breaks = 30)
hist(all_pcr$med_income, breaks = 30)

ggplot(all_pcr,
       aes(x = zip)) +
  geom_bar() +
  theme(axis.text.x = element_text(size = 7, angle = 90))
# Santa Ana 92703 has highest zip code representation in data, 
# reasonable since they have almost the max population density.
# Similarly the next highest is Anaheim 92804,
# also has a population density in last quartile



ggplot(all_zip[order(all_zip$med_income), ],
       aes(x = zip, y = med_income)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(size = 9, angle = 90)) +
  scale_x_discrete(limits = all_zip$zip[order(all_zip$med_income)]) +
  ylab("Median Income (in $10,000)")
# investigate highest median income
length(unique(all_zip$med_income))
#no zip codes have the same median income
all_zip[all_zip$zip == "92657",]
# Newport coast has highest median income ... yup


ggplot(all_pcr,
       aes(x = race)) +
  geom_bar() +
  theme(axis.text.x = element_text(size = 12, angle = 45)) +
  geom_text(stat='count', aes(label=..count..), vjust=-1)
# Need to investigate multiple_races because it is getting extreme estimate odds
summary(all_pcr)
summary(all_pcr[all_pcr$race == "multiple races",])
# across all of the data the sample probability of testing covid positive is 0.1439
# accros the sample of people with multiple races the probability of testing covid positive is 0.8204

# It is not because of the race not being an available classification
summary(all_pcr$time_days)
summary(all_pcr$time_days[all_pcr$race == "multiple races"])
```



Also, we saw a bimodal distribution to income when we graphed it from the patients data.

```{r , eval = FALSE}
hist(all_pcr$med_income, breaks = 40, main = "Histogram of median income ($10,000) from all patient data")

hist(all_zip$med_income, breaks = 40, main = "Histogram of median income ($10,000) from zip code data")
#text(x = h$mids, y = h$counts, 
#     labels=h$counts, adj=c(0.5, -0.5))

ggplot(all_pcr, 
       aes(med_income, fill = zip)) +
  geom_histogram(bins = 40) +
  theme(legend.position = "none")
#theme(legend.text = element_text(size = 3)) +
#guides(color = guide_legend(override.aes = list(size = 0.5))) +
#guides(shape = guide_legend(override.aes = list(size = 0.5)))
```


```{r , eval = FALSE}
ggplot(all_zip[order(all_zip$med_income), ],
       aes(x = zip, y = med_income)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(size = 6, angle = 90)) +
  scale_x_discrete(limits = all_zip$zip[order(all_zip$med_income)]) +
  ylab("Median Income (in $10,000)")
# investigate highest median income
#length(unique(all_zip$med_income))
#no zip codes have the same median income
#all_zip[all_zip$zip == "92657",]
# Newport coast has highest median income ... yup
```

No two zipcode have the same median income and the zip code with the highest median income is Newport Coast 92657.


```{r, eval = FALSE}
ggplot(all_pcr,
       aes(x = zip)) +
  geom_bar() +
  theme(axis.text.x = element_text(size = 6, angle = 90)) +
  ggtitle("Representation of zipcodes in patient data")
```

Santa Ana 92703 has highest zip code representation in data, reasonable since they have almost the max population density.
Similarly the next highest is Anaheim 92804, also has a population density in last quartile


## Unkown test results  
We have 524 observations that are dropped because their test results are classified as unknown

```{r, eval = FALSE}
ggplot(pcr_results_adjusted[pcr_results_adjusted$test_result == "unknown", ],
       aes(x = zip)) +
  geom_bar() +
  theme(axis.text.x = element_text(size = 7, angle = 90))
```

There are 30 observations from the zip code 92804 dropped.








